function testPagewiseComputationTangStiffMtxIGAMembrane(testCase)
%% Licensing
%
% License:         BSD License
%                  cane Multiphysics default license: cane/license.txt
%
% Main authors:    Andreas Apostolatos
%
%% Function documentation
%
% Tests the pagewise computation of the tangent stiffness matrix for the
% geometrically nonlinear isogeometric membrane against the standard 
% computation.
% 
% Function layout :
%
% 0. Read input
%
% 1. Define the multipatch geometry in terms of NURBS
%
% 2. Define the material parameters
%
% 3. GUI
%
% 4. Define the refinement
%
% 5. Define the boundary conditions
%
% 6. Create the patch cell arrays
%
% 7. Define some non-zero pseudo-displacement fields
%
% 8. Compute the stiffness matrices for each patch with and without the pagewise computation
%
% 9. Verify the components of the matrices using both computational methods
%
%% Function main body

%% 0. Read input

% Define absolute tolerances
tol = 1e-11;
tolRelaxed = tol*1e1;

%% 1. Define the multipatch geometry in terms of NURBS

% Patch 1 :
% _________

% Polynomial degrees
p1 = 3;
q1 = 3;

% Knot vectors
Xi1 = [0                   0                   0                   0   0.250000000000000   0.500000000000000   0.750000000000000   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];
Eta1 = [0                   0                   0                   0   0.250000000000000   0.500000000000000   0.750000000000000   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];

% Control Point coordinates

% x-coordinates
CP1(:,:,1) = [ 0.000022867094571   0.000035119722912   0.000001035601124   0.000006705249475   0.000045674832679   0.000038568468851   0.000010407239998
               0.009277062189291   0.009251599838365   0.009495950551896   0.011100958317388   0.014257497337254   0.016941790904862   0.018545853760599
               0.028733392433397   0.028892130318739   0.030143037385988   0.036093167269484   0.045099706586407   0.050248472902171   0.052102400048994
               0.054556904740766   0.055241300949359   0.057540643826371   0.063432971837646   0.069236606337776   0.071718727946559   0.072965531046994
               0.071437378181871   0.071792476189313   0.072616511587947   0.073730655958567   0.074444212833938   0.074614249908594   0.074278497047318
               0.074982003480770   0.074942797982544   0.074870203474400   0.074820713340642   0.074904812291115   0.074952450902198   0.075265362884210
               0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000];
           
% y-coordinates
CP1(:,:,2) = [-0.075013722125308  -0.074565376505715  -0.073645741612319  -0.060871571574374  -0.031520743977672  -0.008611822912220  -0.000115445722182
              -0.074974998381133  -0.074760830642726  -0.073309866260223  -0.061240926109667  -0.031258155367021  -0.008908527578782  -0.000142970948331
              -0.071438552670582  -0.071125484056052  -0.069598392925522  -0.056091050477030  -0.027083020797180  -0.007337640281447  -0.000001485232067
              -0.054559193153464  -0.053718356027475  -0.050115341589234  -0.035670014096897  -0.015248974606316  -0.004214450082809  -0.000107592397475
              -0.028727180282371  -0.027409572931315  -0.023563564754031  -0.015053150216083  -0.006343123809027  -0.001795247054066   0.000006976539014
              -0.009290350669574  -0.008715088733919  -0.007300813495837  -0.004695487402838  -0.002047245878394  -0.000609984928643  -0.000087275696168
                               0                   0                   0                   0                   0                   0                   0];
                           
% z-coordinates
CP1(:,:,3) =  [0.000093035964521   0.004782104768137   0.016880239276715   0.044354654258855   0.067501637372110   0.071180906088664   0.071074231130915
               0.000248557913335   0.004827132437433   0.016961279988451   0.044287367433845   0.067846710643199   0.071235238315957   0.071083993178787
               0.000128072998144   0.004826537183657   0.016718273196706   0.041308794191841   0.058456088179468   0.057886947559116   0.056284866026030
               0.000234450506245   0.004054974033415   0.013038972789089   0.025465395854820   0.028861376810054   0.024554533239256   0.021714552980558
               0.000108445915018   0.002130911279035   0.005945472740001   0.008761377337814   0.007717473071696   0.005093526975170   0.003716958805568
               0.000297547673634   0.000848492019073   0.001779656862434   0.002302455606454   0.001703895905756   0.000673988698803  -0.000040029145179
                               0                   0                   0                   0                   0                   0                   0];

% weights
CP1(:,:,4) = [ 1.000000000000000   0.951184463531091   0.877961158827728   0.841349506476047   0.877961158827728   0.951184463531091   1.000000000000000
               0.951184463531091   0.904751883662930   0.835103013860688   0.800278578959567   0.835103013860688   0.904751883662930   0.951184463531091
               0.877961158827728   0.835103013860688   0.770815796410127   0.738672187684847   0.770815796410127   0.835103013860688   0.877961158827728
               0.841349506476047   0.800278578959567   0.738672187684847   0.707868992047487   0.738672187684847   0.800278578959567   0.841349506476047
               0.877961158827728   0.835103013860688   0.770815796410127   0.738672187684847   0.770815796410127   0.835103013860688   0.877961158827728
               0.951184463531091   0.904751883662930   0.835103013860688   0.800278578959567   0.835103013860688   0.904751883662930   0.951184463531091
               1.000000000000000   0.951184463531091   0.877961158827728   0.841349506476047   0.877961158827728   0.951184463531091   1.000000000000000];

% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS1 = 0;
nxi1 = length(CP1(:,1,1));
neta1 = length(CP1(1,:,1));
for i = 1:nxi1
    for j = 1:neta1
        if CP1(i,j,4)~=1
            isNURBS1 = 1;
            break;
        end
    end
    if isNURBS1
        break;
    end
end

% Patch 2 :
% _________

% Polynomial degrees
p2 = 2;
q2 = 2;

% Knot vectors
Xi2 = [0                   0                   0   0.200000000000000   0.400000000000000   0.600000000000000   0.800000000000000   1.000000000000000   1.000000000000000   1.000000000000000];
Eta2 = [0                   0                   0   0.200000000000000   0.400000000000000   0.600000000000000   0.800000000000000   1.000000000000000   1.000000000000000   1.000000000000000];

% Control Point coordinates

% x-coordinates
CP2(:,:,1) = [ 0.000016425747060   0.000031745809242   0.000088021166202   0.000021236956060   0.000164897957842   0.000033183008712  -0.000051056604506
               0.011257443239105   0.011232080084851   0.012003201374167   0.013957105437588   0.017039819266153   0.020692972698759   0.022743972302419
               0.033675336842216   0.034003588381138   0.036615356107482   0.041555367650640   0.047896185197703   0.053600429379722   0.055708774551672
               0.053758940050079   0.054483474777859   0.057493852687513   0.061883079555439   0.066393910503560   0.069849495226914   0.071179329521338
               0.068108821210573   0.068639703991042   0.070118764205372   0.071805852014961   0.073272819275132   0.074226752124110   0.074318307690665
               0.074990841840994   0.074976970748160   0.074939717817537   0.074907233094809   0.074903223354626   0.074916311828097   0.075000028851767
               0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000   0.075000000000000];
           
% y-coordinates
CP2(:,:,2) = [ 0.074984655728196   0.074733220445636   0.071125946535644   0.059405460151908   0.037023974497659   0.010941860875007   0.000016117379189
               0.074998454778726   0.074809374366434   0.071118123277865   0.059432511314393   0.037007786926963   0.010811027065531   0.000052462802692
               0.068104545725500   0.067748955524731   0.063056153858351   0.050635298429722   0.030021977514748   0.008356579627667   0.000100405651803
               0.053762430410268   0.052812070302898   0.046787686648732   0.035081148444653   0.019544917582670   0.005208369640918   0.000028283786395
               0.033671068164572   0.032237672118054   0.026825895773661   0.018932025883884   0.010200574528612   0.002735104895334   0.000062988745411
               0.011266274277255   0.010412042157745   0.008178842904191   0.005580138837548   0.003013517562367   0.000848344288698   0.000034439721861
                               0                   0                   0                   0                   0                   0                   0];
                           
% z-coordinates
CP2(:,:,3) = [ 0.000133968871205   0.005629392578880   0.022396387202286   0.044022843841307   0.062695016227076   0.071440606690705   0.071159624701325
               0.000095272298844   0.005712274449556   0.022420908756995   0.043996407374524   0.062854875835036   0.070859871248032   0.070323820715390
               0.000106684367989   0.005531948809171   0.020348241496979   0.037323976891678   0.049377741172113   0.051565317994574   0.049159991405146
               0.000114524349867   0.004692524316559   0.015167547571914   0.024589722846228   0.028776877451213   0.026542291453420   0.023303079234442
               0.000084821091929   0.002986052469047   0.008215782091019   0.011574995817638   0.011825044881371   0.009220247458303   0.007127532325394
               0.000158542918381   0.001007738249866   0.002144933523463   0.002525782248930   0.002058102474413   0.000894844072834   0.000045186664691
                               0                   0                   0                   0                   0                   0                   0];
                           
% weights
CP2(:,:,4) = [ 1.000000000000000   0.941421356237309   0.871126983722081   0.847695526217005   0.871126983722081   0.941421356237309   1.000000000000000
               0.941421356237309   0.886274169979695   0.820097546470558   0.798038671967512   0.820097546470558   0.886274169979695   0.941421356237309
               0.871126983722081   0.820097546470558   0.758862221768731   0.738450446868122   0.758862221768731   0.820097546470558   0.871126983722081
               0.847695526217005   0.798038671967513   0.738450446868122   0.718587705168325   0.738450446868122   0.798038671967513   0.847695526217005
               0.871126983722081   0.820097546470558   0.758862221768731   0.738450446868122   0.758862221768731   0.820097546470558   0.871126983722081
               0.941421356237309   0.886274169979695   0.820097546470558   0.798038671967512   0.820097546470558   0.886274169979695   0.941421356237309
               1.000000000000000   0.941421356237309   0.871126983722081   0.847695526217005   0.871126983722081   0.941421356237309   1.000000000000000];
          
% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS2 = 0;
nxi2 = length(CP2(:,1,1));
neta2 = length(CP2(1,:,1));
for i = 1:nxi2
    for j = 1:neta2
        if CP2(i,j,4)~=1
            isNURBS2 = 1;
            break;
        end
    end
    if isNURBS2
        break;
    end
end

% Patch 3 :
% _________

% Polynomial degrees
p3 = 3;
q3 = 3;

% Knot vectors
Xi3 = [0                   0                   0                   0   0.250000000000000   0.500000000000000   0.750000000000000   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];
Eta3 = [0                   0                   0                   0   0.250000000000000   0.500000000000000   0.750000000000000   1.000000000000000   1.000000000000000   1.000000000000000   1.000000000000000];

% Control Point coordinates

% x-coordinates
CP3(:,:,1) = [-0.000032043259049  -0.000100423347128   0.000036954935799  -0.000159693260713   0.000092243086846  -0.000209921565859  -0.000140958015947
              -0.009271889375811  -0.009239682713439  -0.009542551929622  -0.011128728427388  -0.014291172371632  -0.016847560709025  -0.018168359670256
              -0.028736679897288  -0.028906407603449  -0.030150197720360  -0.036130302699402  -0.045155057166559  -0.050485622396963  -0.052646273639833
              -0.054555129032145  -0.055240270748258  -0.057556421091025  -0.063460793213194  -0.069288777611491  -0.071690311671755  -0.072722648433519
              -0.071439137396375  -0.071798097508275  -0.072622619505625  -0.073737812903113  -0.074432384836266  -0.074609185145529  -0.074441812923579
              -0.074980540825455  -0.074940804489678  -0.074866377609056  -0.074819145306863  -0.074896616340845  -0.074964505410922  -0.075171802386197
              -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000];
          
% y-coordinates
CP3(:,:,2) = [ 0.075004420899880   0.074629983293583   0.073450556479942   0.061021186769424   0.031178667046774   0.008778576228778   0.000046001300409
               0.074980331478400   0.074720547783603   0.073334488492828   0.061145559291331   0.031269561671281   0.008768853550777  -0.000017650787403
               0.071435339881571   0.071140839303276   0.069558992931458   0.056089245416724   0.027008287560907   0.007339268224717   0.000029390740269
               0.054560755692977   0.053706623752802   0.050117039338591   0.035635385840845   0.015228567814936   0.004140237386789  -0.000001885734257
               0.028726160461781   0.027412545243512   0.023550941858818   0.015045454249348   0.006310456393732   0.001781470573310   0.000017379365586
               0.009290324905769   0.008710690939699   0.007293801040905   0.004680326677628   0.002031145846903   0.000597144645429   0.000033979518459
                               0                   0                   0                   0                   0                   0                   0];
                           
% z-coordinates
CP3(:,:,3) = [ 0.000121391966085   0.004783720282612   0.016916382899611   0.044452135688450   0.067303382523066   0.071330072630443   0.071056162965220
               0.000231087501442   0.004838442570436   0.017000571125089   0.044288696573001   0.067880519649304   0.071375842448629   0.071555571008139
               0.000138849010815   0.004828712886668   0.016726622801973   0.041325257447504   0.058440903136187   0.057741800615000   0.055764198293831
               0.000228580936102   0.004053577476586   0.013037113306547   0.025454438399792   0.028857036573255   0.024628635551250   0.022083386905108
               0.000113079793265   0.002133279611930   0.005946032989511   0.008767147728263   0.007710480857808   0.005045882145833   0.003377000162130
               0.000294579241198   0.000843645161931   0.001774554431271   0.002282521581330   0.001694886321290   0.000638289902881   0.000108624133762
                               0                   0                   0                   0                   0                   0                   0];
                           
% weights
CP3(:,:,4) = [ 1.000000000000000   0.951184463531091   0.877961158827728   0.841349506476047   0.877961158827728   0.951184463531091   1.000000000000000
               0.951184463531091   0.904751883662930   0.835103013860688   0.800278578959567   0.835103013860688   0.904751883662930   0.951184463531091
               0.877961158827728   0.835103013860688   0.770815796410127   0.738672187684847   0.770815796410127   0.835103013860688   0.877961158827728
               0.841349506476047   0.800278578959567   0.738672187684847   0.707868992047487   0.738672187684847   0.800278578959567   0.841349506476047
               0.877961158827728   0.835103013860688   0.770815796410127   0.738672187684847   0.770815796410127   0.835103013860688   0.877961158827728
               0.951184463531091   0.904751883662930   0.835103013860688   0.800278578959567   0.835103013860688   0.904751883662930   0.951184463531091
               1.000000000000000   0.951184463531091   0.877961158827728   0.841349506476047   0.877961158827728   0.951184463531091   1.000000000000000];

% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS3 = 0;
nxi3 = length(CP3(:,1,1));
neta3 = length(CP3(1,:,1));
for i = 1:nxi3
    for j = 1:neta3
        if CP3(i,j,4)~=1
            isNURBS3 = 1;
            break;
        end
    end
    if isNURBS3
        break;
    end
end

% Patch 4 :
% _________

% Polynomial degrees
p4 = 2;
q4 = 2;

% Knot vectors
Xi4 = [0                   0                   0   0.166666666666667   0.333333333333333   0.500000000000000   0.666666666666667   0.833333333333333   1.000000000000000   1.000000000000000   1.000000000000000];
Eta4 = [0                   0                   0   0.166666666666667   0.333333333333333   0.500000000000000   0.666666666666667   0.833333333333333   1.000000000000000   1.000000000000000   1.000000000000000];

% Control Point coordinates

% x-coordinates
CP4(:,:,1) = [-0.000006447535074  -0.000013480720912  -0.000037904238259  -0.000053020639367  -0.000042377311312  -0.000033544459398  -0.000030800324503  -0.000082190832114
              -0.009288941011998  -0.009266599769209  -0.009684584218310  -0.010708477618122  -0.012412469621488  -0.014665745315078  -0.017107476072637  -0.018382193891834
              -0.027977598535028  -0.028158406498128  -0.029689690344240  -0.032704796035018  -0.037100633148018  -0.042074794084516  -0.046609043352176  -0.048524371276763
              -0.045708399931002  -0.046202039697387  -0.048455808253021  -0.052116215517603  -0.056692882449002  -0.061163367070876  -0.064730967675849  -0.066122876341935
              -0.060353037665224  -0.060933696915153  -0.062843626147230  -0.065421704184019  -0.068204387075483  -0.070628896907197  -0.072420959465677  -0.073045768976382
              -0.070295604743789  -0.070616427616300  -0.071438183148227  -0.072380391608797  -0.073289297078885  -0.074014329977906  -0.074441589166478  -0.074444833211869
              -0.074995924711324  -0.074978072836017  -0.074943091194431  -0.074914990725995  -0.074902652459066  -0.074916753455515  -0.074959310242346  -0.075105267841653
              -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000  -0.075000000000000];

% y-ccordinates
CP4(:,:,2) = [-0.074989406148233  -0.074717471995759  -0.072433204335608  -0.065203561627898  -0.050797151879083  -0.030464128821955  -0.008869853374972  -0.000040596819812
              -0.075001173431823  -0.074832678876801  -0.072361617197174  -0.065238674302988  -0.050914724106887  -0.030288829166765  -0.008974826555784  -0.000077512955362
              -0.070293366488245  -0.070033177721684  -0.067090568687494  -0.059398886490934  -0.045177967024922  -0.026123898909449  -0.007447693998404  -0.000051761441085
              -0.060353842013879  -0.059784844150910  -0.055893806594458  -0.047665237356398  -0.034689037815248  -0.019277321186209  -0.005342416927672  -0.000043542628868
              -0.045708582676608  -0.044705638837693  -0.040287326107411  -0.032823398655193  -0.022886926944074  -0.012377516153941  -0.003394022793436  -0.000044245315414
              -0.027976545764436  -0.026853702377551  -0.023231657688924  -0.018201018430574  -0.012351834028665  -0.006616594753349  -0.001828187095619  -0.000019414436145
              -0.009292047736415  -0.008712324014921  -0.007248440550403  -0.005523114135737  -0.003708888066985  -0.002005468039444  -0.000573034267296  -0.000017628587256
                               0                   0                   0                   0                   0                   0                   0                   0];

% z-coordinates
CP4(:,:,3) = [ 0.000073773553384   0.004738927624671   0.017636943156658   0.034809935949714   0.052421971909319   0.065701683427051   0.071220471593715   0.071135536304115
               0.000035338724101   0.004659098777563   0.017737283671859   0.034717183123954   0.052539260920391   0.065697071374746   0.071122827156859   0.070994721639403
               0.000055677362577   0.004599221506886   0.016764554908610   0.031712752520136   0.046107067908346   0.055152728237049   0.056869669895192   0.055124400366144
               0.000043798464764   0.004177609830591   0.014207788638605   0.025082701530148   0.033869674608826   0.037634271292723   0.036144547139521   0.033779418330172
               0.000055244733637   0.003290632560638   0.010132350415976   0.016372767592061   0.020240718901827   0.020648382324412   0.017989632132455   0.015637001880872
               0.000037776472475   0.001993120740389   0.005512390499701   0.008115403056335   0.009156265943575   0.008431909185066   0.006293806255960   0.004818806555060
               0.000073794878500   0.000652361354923   0.001511074784107   0.001974421961991   0.001953083394966   0.001457347846413   0.000596530157630   0.000016718453698
                               0                   0                   0                   0                   0                   0                   0                   0];
                           
% weights
CP4(:,:,4) = [ 1.000000000000000   0.951184463531091   0.886097081572546   0.853553390593274   0.853553390593274   0.886097081572546   0.951184463531091   1.000000000000000
               0.951184463531091   0.904751883662930   0.842841777172048   0.811886723926607   0.811886723926607   0.842841777172048   0.904751883662930   0.951184463531091
               0.886097081572546   0.842841777172048   0.785168037971384   0.756331168371052   0.756331168371052   0.785168037971384   0.842841777172048   0.886097081572546
               0.853553390593274   0.811886723926607   0.756331168371052   0.728553390593274   0.728553390593274   0.756331168371052   0.811886723926607   0.853553390593274
               0.853553390593274   0.811886723926607   0.756331168371052   0.728553390593274   0.728553390593274   0.756331168371052   0.811886723926607   0.853553390593274
               0.886097081572546   0.842841777172048   0.785168037971384   0.756331168371052   0.756331168371052   0.785168037971384   0.842841777172048   0.886097081572546
               0.951184463531091   0.904751883662930   0.842841777172048   0.811886723926607   0.811886723926607   0.842841777172048   0.904751883662930   0.951184463531091
               1.000000000000000   0.951184463531091   0.886097081572546   0.853553390593274   0.853553390593274   0.886097081572546   0.951184463531091   1.000000000000000];

% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS4 = 0;
nxi4 = length(CP4(:,1,1));
neta4 = length(CP4(1,:,1));
for i = 1:nxi4
    for j = 1:neta4
        if CP4(i,j,4)~=1
            isNURBS4 = 1;
            break;
        end
    end
    if isNURBS4
        break;
    end
end

%% 2. Define the material parameters

% Force amplitude
FAmp = +19*100;

% Parameters
EYoung = 7.0e5;
poissonRatio = .49;
thickness = 1.65e-4;
density = 1050;
prestress.computeParametricCoordinates = @(X) [X(1,1)^2 + X(2,1)^2
                                               atan(X(2,1)/X(1,1))];
prestress.computeBaseVectors = @(theta1,theta2) [cos(theta2) -sin(theta2)
                                                 sin(theta2) cos(theta2)
                                                 0           0];
% prestress.voigtVector = [abs(FAmp)*Radius/2
%                          abs(FAmp)*Radius/2
%                          0];
prestress.voigtVector = [0.712500000000000/thickness
                         0.712500000000000/thickness
                         0];

% Patch 1 :
% _________

% Young's modulus
parameters1.E = EYoung;

% Poisson ratio
parameters1.nue = poissonRatio;

% Thickness of the plate
parameters1.t = thickness;

% Density of the membrane (used only for dynamics)
parameters1.rho = density;

% Prestress for the membrane
parameters1.prestress = prestress;

% Patch 2 :
% _________

% Young's modulus
parameters2.E = EYoung;

% Poisson ratio
parameters2.nue = poissonRatio;

% Thickness of the plate
parameters2.t = thickness;

% Density of the membrane (used only for dynamics)
parameters2.rho = density;

% Prestress for the membrane
parameters2.prestress = prestress;

% Patch 3 :
% _________

% Young's modulus
parameters3.E = EYoung;

% Poisson ratio
parameters3.nue = poissonRatio;

% Thickness of the plate
parameters3.t = thickness;

% Density of the membrane (used only for dynamics)
parameters3.rho = density;

% Prestress for the membrane
parameters3.prestress = prestress;

% Patch 4 :
% _________

% Young's modulus
parameters4.E = EYoung;

% Poisson ratio
parameters4.nue = poissonRatio;

% Thickness of the plate
parameters4.t = thickness;

% Density of the membrane (used only for dynamics)
parameters4.rho = density;

% Prestress for the membrane
parameters4.prestress = prestress;

%% 3. GUI

% Analysis type
analysis.type = 'isogeometricMembraneAnalysis';

% General dummy parameters
propCoupling = 'undefined';
loadFactor = 'undefined';
propTransientAnalysis = 'undefined';
tab = '';
noTimeStep = 'undefined';
noNonlinearIteration = 1;
connections = 'undefined';

% Integration scheme
% type = 'default' : default FGI integration element-wise
% type = 'manual' : manual choice of the number of Gauss points

% Patch 1 :
% _________

int1.type = 'default';
if strcmp(int1.type,'user')
    int1.xiNGP = 6;
    int1.etaNGP = 6;
    int1.xiNGPForLoad = 6;
    int1.etaNGPForLoad = 6;
    int1.nGPForLoad = 6;
    int1.nGPError = 12;
end

% Patch 2 :
% _________

int2.type = 'default';
if strcmp(int2.type,'user')
    int2.xiNGP = 6;
    int2.etaNGP = 6;
    int2.xiNGPForLoad = 6;
    int2.etaNGPForLoad = 6;
    int2.nGPForLoad = 6;
    int2.nGPError = 12;
end

% Patch 3 :
% _________

int3.type = 'default';
if strcmp(int3.type,'user')
    int3.xiNGP = 6;
    int3.etaNGP = 6;
    int3.xiNGPForLoad = 6;
    int3.etaNGPForLoad = 6;
    int3.nGPForLoad = 6;
    int3.nGPError = 12;
end

% Patch 4 :
% _________

int4.type = 'default';
if strcmp(int4.type,'user')
    int4.xiNGP = 6;
    int4.etaNGP = 6;
    int4.xiNGPForLoad = 6;
    int4.etaNGPForLoad = 6;
    int4.nGPForLoad = 6;
    int4.nGPError = 12;
end

%% 4. Define the refinement

%%%%%%%%%%%%%%%%%%%%
% Degree elevation %
%%%%%%%%%%%%%%%%%%%%

% Patch 1 :
% _________

a = 0;
tp1 = a;
tq1 = a;
[Xi1,Eta1,CP1,p1,q1] = degreeElevateBSplineSurface(p1,q1,Xi1,Eta1,CP1,tp1,tq1,'');

% Patch 2 :
% _________

b = 0;
tp2 = b;
tq2 = b;
[Xi2,Eta2,CP2,p2,q2] = degreeElevateBSplineSurface(p2,q2,Xi2,Eta2,CP2,tp2,tq2,'');

% Patch 3 :
% _________

c = 0;
tp3 = c;
tq3 = c;
[Xi3,Eta3,CP3,p3,q3] = degreeElevateBSplineSurface(p3,q3,Xi3,Eta3,CP3,tp3,tq3,'');

% Patch 4 :
% _________

d = 0;
tp4 = d;
tq4 = d;
[Xi4,Eta4,CP4,p4,q4] = degreeElevateBSplineSurface(p4,q4,Xi4,Eta4,CP4,tp4,tq4,'');

%%%%%%%%%%%%%%%%%%%%
% Knot insertion   %
%%%%%%%%%%%%%%%%%%%%

% Patch 1 :
% _________

noKnotsXi1 = 1;
noKnotsEta1 = noKnotsXi1;
[Xi1,Eta1,CP1] = knotRefineUniformlyBSplineSurface...
    (p1,Xi1,q1,Eta1,CP1,noKnotsXi1,noKnotsEta1,'');

% Patch 2 :
% _________

noKnotsXi2 = 1;
noKnotsEta2 = noKnotsXi2;
[Xi2,Eta2,CP2] = knotRefineUniformlyBSplineSurface...
    (p2,Xi2,q2,Eta2,CP2,noKnotsXi2,noKnotsEta2,'');

% Patch 3 :
% _________

noKnotsXi3 = 1;
noKnotsEta3 = noKnotsXi3;
[Xi3,Eta3,CP3] = knotRefineUniformlyBSplineSurface...
    (p3,Xi3,q3,Eta3,CP3,noKnotsXi3,noKnotsEta3,'');

% Patch 4 :
% _________

noKnotsXi4 = 1;
noKnotsEta4 = noKnotsXi4;
[Xi4,Eta4,CP4] = knotRefineUniformlyBSplineSurface...
    (p4,Xi4,q4,Eta4,CP4,noKnotsXi4,noKnotsEta4,'');

%% 5. Define the boundary conditions

% Neumann boundary conditions
% ---------------------------

% General parameters
loadAmplitude = FAmp;
dirForce = 'normal';
isFollower = true;

% Patch 1 :
% _________

NBC1.noCnd = 1;
xib1 = [0 1];   etab1 = [0 1];
NBC1.xiLoadExtension = {xib1};
NBC1.etaLoadExtension = {etab1};
NBC1.loadAmplitude = {loadAmplitude};
% NBC1.loadAmplitude = {@(x,y,z,t) (t<=5)*FAmp + (t>5)*FAmp*9e-1};
NBC1.loadDirection = {dirForce};
NBC1.computeLoadVct{1} = 'computeLoadVctAreaIGAThinStructure';
NBC1.isFollower(1,1) = isFollower;
NBC1.isTimeDependent(1,1) = false;
        
% Patch 2 :
% _________

NBC2.noCnd = 1;
xib2 = [0 1];   etab2 = [0 1];
NBC2.xiLoadExtension = {xib2};
NBC2.etaLoadExtension = {etab2};
NBC2.loadAmplitude = {-loadAmplitude};
% NBC2.loadAmplitude = {@(x,y,z,t) - (t<=5)*FAmp - (t>5)*FAmp*9e-1};
NBC2.loadDirection = {dirForce};
NBC2.computeLoadVct{1} = 'computeLoadVctAreaIGAThinStructure';
NBC2.isFollower(1,1) = isFollower;
NBC2.isTimeDependent(1,1) = false;

% Patch 3 :
% _________

NBC3.noCnd = 1;
xib3 = [0 1];   etab3 = [0 1];
NBC3.xiLoadExtension = {xib3};
NBC3.etaLoadExtension = {etab3};
NBC3.loadAmplitude = {loadAmplitude};
% NBC3.loadAmplitude = {@(x,y,z,t) (t<=5)*FAmp + (t>5)*FAmp*9e-1};
NBC3.loadDirection = {dirForce};
NBC3.computeLoadVct{1} = 'computeLoadVctAreaIGAThinStructure';
NBC3.isFollower(1,1) = isFollower;
NBC3.isTimeDependent(1,1) = false;

% Patch 4 :
% _________

NBC4.noCnd = 1;
xib4 = [0 1];   etab4 = [0 1];
NBC4.xiLoadExtension = {xib4};
NBC4.etaLoadExtension = {etab4};
NBC4.loadAmplitude = {-loadAmplitude};
% NBC4.loadAmplitude = {@(x,y,z,t) - (t<=5)*FAmp - (t>5)*FAmp*9e-1};
NBC4.loadDirection = {dirForce};
NBC4.computeLoadVct{1} = 'computeLoadVctAreaIGAThinStructure';
NBC4.isFollower(1,1) = isFollower;
NBC4.isTimeDependent(1,1) = false;

% Cables
% ------

% Patch 1 :
% _________

cables1.No = 0;

% Patch 2 :
% _________

cables2.No = 0;

% Patch 4 :
% _________

cables3.No = 0;

% Patch 4 :
% _________

cables4.No = 0;

%% 6. Create the patch cell arrays

% Patch 1 :
% _________

patch1 = fillUpPatch(analysis,p1,Xi1,q1,Eta1,CP1,isNURBS1,...
    parameters1,[],[],[],[],cables1,NBC1,[],[],[],[],[],int1);

% Patch 2 :
% _________

patch2 = fillUpPatch(analysis,p2,Xi2,q2,Eta2,CP2,isNURBS2,...
    parameters2,[],[],[],[],cables2,NBC2,[],[],[],[],[],int2);

% Patch 3 :
% _________

patch3 = fillUpPatch(analysis,p3,Xi3,q3,Eta3,CP3,isNURBS3,...
    parameters3,[],[],[],[],cables3,NBC3,[],[],[],[],[],int3);

% Patch 4 :
% _________

patch4 = fillUpPatch(analysis,p4,Xi4,q4,Eta4,CP4,isNURBS4,...
    parameters4,[],[],[],[],cables4,NBC4,[],[],[],[],[],int4);

% Collect all patches into an array :
% ___________________________________

BSplinePatches = {patch1 patch2 patch3 patch4};

%% 7. Define some non-zero pseudo-displacement fields

% Patch 1 :
% _________

dHat1 = [  0.747785372301515
           0.305726330316065
           0.765444360828540
           0.252885731381430
           0.671015975405850
           0.131914107685128
           0.942448397517158
           0.444583183003789
           0.357995338956069
           0.169800958046254
           0.499074065297007
           0.452166200378947
           0.066215980185090
           0.887881674640202
           0.907784125901346
           0.782654328509083
           0.471943559212895
           0.796142303750967
           0.875647388455270
           0.672251562170698
           0.070382735692499
           0.124471905163670
           0.425366183349375
           0.782665768727162
           0.589146545218194
           0.472135906386569
           0.033788471312084
           0.180073535625725
           0.931819658789012
           0.590764009202279
           0.506335507400454
           0.218438856708936
           0.952051035940071
           0.362259513867018
           0.458546754703170
           0.830810137981569
           0.790665029293851
           0.441022733276423
           0.624033793781809
           0.955508256317789
           0.663478658469131
           0.266490943364355
           0.723154840215161
           0.561077886344455
           0.972980667353596
           0.300872644671042
           0.497020498287351
           0.283954108418013
           0.074208004790691
           0.111397187358409
           0.075306935970584
           0.996192027605659
           0.599597679942704
           0.788968013382453
           0.861268639611926
           0.827068266282738
           0.936923731937818
           0.035853460598729
           0.139710786828577
           0.725442080874176
           0.872094169044431
           0.374103271527148
           0.216187517237589
           0.576010099172980
           0.025646755078704
           0.043504924599435
           0.933449284045686
           0.401651928267034
           0.784920768198348
           0.242628568324623
           0.608542724961418
           0.893183909504416
           0.629419861274986
           0.924146871351501
           0.995804571701050
           0.150089872708110
           0.024796899764211
           0.911264097869455
           0.147997458476270
           0.089943057289148
           0.715693599151247
           0.175014408721400
           0.159721590176509
           0.478932143833692
           0.948731651592942
           0.741070141458400
           0.672333462130722
           0.070345247769212
           0.306105485335777
           0.936833055516247
           0.856937003671443
           0.890847380737143
           0.588586918837613
           0.162586327547285
           0.176045119807099
           0.747563614665687
           0.945285815976482
           0.657979789002505
           0.543831976949375
           0.597653088285055
           0.234602892008367
           0.819767731385293
           0.788495533288682
           0.589059613176341
           0.436259778173497
           0.549739427769825
           0.352968705935504
           0.995791193528870
           0.364963600015756
           0.966174491517511
           0.024740872952718
           0.777839114133281
           0.440182119351492
           0.630499928301014
           0.314024696202710
           0.921815284507743
           0.223324620519386
           0.374486271858210
           0.308144382373381
           0.037822474122939
           0.605169674511657
           0.835864369359658
           0.588252232813568
           0.363454795408988
           0.139885183619558
           0.116533721537474
           0.981217434069437
           0.541692349030371
           0.086509908438523
           0.256096227788964
           0.209775010836282
           0.314609803604705
           0.903751596102294
           0.520696307127195
           0.162236010012221
           0.143612207513270
           0.064053075478091
           0.854645458623604
           0.974456785593373
           0.929025103554582
           0.409520221274419
           0.901611220034849
           0.484497228782305
           0.469673840237391
           0.167828198886360
           0.082858473102399
           0.633161255034096];
       
% Patch 2 :
% _________

dHat2 = [  0.310978917444454
           0.466354034749258
           0.211069421812716
           0.001445719644097
           0.797611265022929
           0.368047426089151
           0.015137572210005
           0.714978466470137
           0.218578762078392
           0.688717269625175
           0.246007221266387
           0.266084854588675
           0.132070823774348
           0.344210335433149
           0.754389983788448
           0.889238646634628
           0.710436376647841
           0.246475025240484
           0.451389348495065
           0.931224274284887
           0.615667580201693
           0.258289980493455
           0.631103174057245
           0.695532194169074
           0.403659878091701
           0.193481857413117
           0.307074224713182
           0.692954513388275
           0.630359565476236
           0.249823988840664
           0.043422017733594
           0.531451453614820
           0.176201447978594
           0.521902037473046
           0.871282135692825
           0.613612826084653
           0.271432121466628
           0.854539610220498
           0.157460139605902
           0.259418638129986
           0.670580480612924
           0.225957392866863
           0.825966529550158
           0.324096282315350
           0.488386575826106
           0.763723753369187
           0.737675502332654
           0.636025946217411
           0.249140939135425
           0.734316827783819
           0.339505137924502
           0.302767838390180
           0.127141988983118
           0.010140298726183
           0.924928777054715
           0.910006195626544
           0.382147912218909
           0.701392065887907
           0.672341929094608
           0.127674130158185
           0.200969038593963
           0.902826543553463
           0.891836308297259
           0.377681734866925
           0.250192901317445
           0.602701480231355
           0.625450545463954
           0.019682889478875
           0.819732602404028
           0.517944571318759
           0.909434244169669
           0.118624967385146
           0.946149041256063
           0.927044817717209
           0.094805011213359
           0.415257389145110
           0.322862316746869
           0.846253559373736
           0.947950319602612
           0.729220577434225
           0.683849724775500
           0.641411905643839
           0.315882600559583
           0.732146773481898
           0.157648409491942
           0.760070691228337
           0.091909903173074
           0.967653991957030
           0.608966348346455
           0.894952440275417
           0.194146530723079
           0.988057942048401
           0.241314861573950
           0.223420955768555
           0.401997941784720
           0.780906365500356
           0.839212012936910
           0.409499774557134
           0.402400532579752
           0.771750033223037
           0.249124686312797
           0.865741064645646
           0.682186066810687
           0.977392980408560
           0.185523905543996
           0.216182760513138
           0.312921858193491
           0.752012037725730
           0.367736606860203
           0.604456003539142
           0.383434891407544
           0.550487829259962
           0.385442421714884
           0.665435033273495
           0.014714163546339
           0.813124468759885
           0.349855974829203
           0.715515525264852
           0.958893803878619
           0.507417120718267
           0.666168220267888
           0.429465434362195
           0.849498543568243
           0.654233377284434
           0.504257747592193
           0.368516059530713
           0.685249429019409
           0.099207515175757
           0.047646836966753
           0.869335914977350
           0.651867365863888
           0.610458701205885
           0.421945705248746
           0.503707374957771
           0.164140923375798
           0.093172129524046
           0.685324864521948
           0.142671298086907
           0.528711653269026
           0.003572773324275
           0.425057790934981
           0.224340905176410
           0.659942132313487
           0.503101896379671
           0.600057239807837
           0.200173658860432
           0.137401018724244];
    
% Patch 3 :
% _________

dHat3 = [  0.023789028634384
           0.939542698220884
           0.695501323790041
           0.554233183009153
           0.295414289119064
           0.042631747505684
           0.853760208334462
           0.596682100841419
           0.018526779642937
           0.933190961871480
           0.009788324266872
           0.640955539628156
           0.788685383549152
           0.526502944231040
           0.291248417281234
           0.628328540883956
           0.425468671551764
           0.546370363272546
           0.190797083318664
           0.744488837009526
           0.212856219278171
           0.100122455877196
           0.896384986297513
           0.822336975387737
           0.882783750050209
           0.088124295412165
           0.700187647740891
           0.170224223729873
           0.833044271053050
           0.728057084721778
           0.775893015135978
           0.763495251449153
           0.057099465574720
           0.609847721618856
           0.898471800448384
           0.516130724509215
           0.506171538067419
           0.255616556410658
           0.971603134958536
           0.581123922450753
           0.968386414336657
           0.041438372920898
           0.188628229362153
           0.519760059068036
           0.640853919662848
           0.340731322525365
           0.648329819207684
           0.355437965546251
           0.850430024041377
           0.542804681241221
           0.673080087460760
           0.256572579313377
           0.121338276707935
           0.040606445860341
           0.887943133089476
           0.753187315831733
           0.802079185026265
           0.441405626647267
           0.075172585716220
           0.154229697287694
           0.247244148394022
           0.079225986854102
           0.853159563134165
           0.157176855290790
           0.616662683688958
           0.528449944458942
           0.191219823355632
           0.759750760227389
           0.614998425492876
           0.152063606777082
           0.454637446858156
           0.682097599808961
           0.281259121575909
           0.624863120814537
           0.941730122601418
           0.566803336047469
           0.693115599105178
           0.978586411034322
           0.899117378675088
           0.648479896015330
           0.982920814944961
           0.163814968179811
           0.509786857227575
           0.627348429656104
           0.800000906333289
           0.417769086107256
           0.054834431893781
           0.519144193650956
           0.134532135688309
           0.366974434645040
           0.696620887403430
           0.129583524717075
           0.785849529987449
           0.050308973596352
           0.815615519700691
           0.866938862459353
           0.196896453653625
           0.607393801126777
           0.996679751886203
           0.042374327460083
           0.138823003129407
           0.222953974091225
           0.583010477964280
           0.671106486855616
           0.723195985118222
           0.504438512986130
           0.644630262831149
           0.036369340676042
           0.193851825334961
           0.749545712102824
           0.308178375844892
           0.749052151824695
           0.852037321352010
           0.099355476382796
           0.597778198787964
           0.720602255764323
           0.568713832115472
           0.235110091085310
           0.910636226408683
           0.950619757095401
           0.516315294819808
           0.707088130257172
           0.798795192940303
           0.199689366652775
           0.106840515449705
           0.618574843315811
           0.022223940782302
           0.037562043688319
           0.115364121588021
           0.818697240446272
           0.376899225803119
           0.229156312136160
           0.368139913036900
           0.174540423871336
           0.774779638832738
           0.330030614354014
           0.315780139928460
           0.724586900626482
           0.584954983442022
           0.777755524267169
           0.359576387650632
           0.184733001916479
           0.573689108128662
           0.483094584564781
           0.421626940454074
           0.317325192381402
           0.972571507193181];
       
% Patch 4 :
% _________

dHat4 = [  0.258222640836992
           0.567099899646433
           0.352066904740983
           0.312029608919655
           0.009397602757391
           0.668127492035812
           0.885687680497191
           0.421317726471668
           0.858580052734657
           0.947992491692748
           0.376106774797058
           0.203293248489839
           0.179169495241401
           0.306294083341210
           0.850311935666138
           0.525602531044741
           0.828442251880212
           0.106876458873914
           0.617142031700498
           0.566826518566431
           0.260936156906943
           0.002308110432938
           0.287255062879815
           0.821270082456773
           0.895115404680466
           0.995807909606230
           0.008438401807034
           0.732843238440102
           0.084617267942532
           0.633348568099204
           0.805086425608580
           0.829964886435069
           0.567221449723939
           0.260043390493052
           0.784532049401665
           0.169205334021096
           0.274258345175233
           0.004903194288563
           0.397561240528039
           0.026551553230801
           0.854699049809875
           0.204891689163361
           0.860350581097684
           0.056124708805549
           0.223511772366391
           0.045280517808393
           0.750991773112615
           0.698056379930209
           0.918787889121138
           0.908922604332158
           0.805523856544559
           0.999677445374649
           0.800766275754545
           0.322915332644130
           0.025144584144454
           0.732823471283791
           0.472786704548189
           0.392588402165001
           0.860014027813345
           0.057461649120615
           0.384545138525541
           0.141840420366856
           0.045681397775018
           0.697994732962103
           0.913511502068192
           0.383545632290609
           0.243110817299358
           0.907097732647764
           0.702017912868084
           0.895637886893663
           0.947973559242691
           0.936691958432421
           0.996786631011984
           0.396942471901925
           0.659936449375974
           0.822950297949471
           0.622366730006282
           0.700506318144961
           0.489515104713947
           0.508816801240717
           0.779713295559863
           0.040485776162860
           0.901007402566114
           0.732045721121022
           0.615783068479236
           0.755188044469967
           0.284467185594173
           0.206249114576936
           0.652186212909185
           0.928119937980734
           0.804573514849910
           0.350436063102228
           0.270188405995597
           0.744617713123743
           0.722992110043540
           0.856720355874117
           0.918819323643678
           0.269008369165018
           0.688151779362003
           0.617997051690114
           0.071553472939427
           0.188398234988831
           0.335569468860859
           0.311045820959137
           0.420204017960576
           0.087738799061613
           0.559868482907010
           0.667625249862375
           0.115301713639157
           0.315660389198990
           0.980796342397318
           0.885869537711305
           0.022758329427491
           0.863285505241343
           0.244993620883412
           0.433601729237960
           0.135376201663307
           0.215599998231807
           0.774728915108001
           0.087186260935252
           0.400377825330332
           0.590110967553579
           0.196523569072947
           0.696812464244864
           0.592969314926699
           0.464189975726267
           0.241154947859450
           0.412770454503875
           0.770494470747454
           0.035338891644633
           0.607550299133461
           0.079473648898011
           0.415376455043999
           0.985477576209605
           0.842648435276967
           0.052402602108058
           0.727517910831110
           0.114958029745548
           0.485380961589241
           0.868594367822937
           0.016703879113697
           0.818908378037653
           0.783873672409838
           0.193707732877488
           0.912844291315192
           0.683689941661077
           0.888393508527682
           0.712869704398642
           0.484892021541747
           0.833218042660154
           0.090746420773067
           0.025491756505365
           0.335727870856154
           0.486922626333375
           0.225362827294348
           0.554708799489516
           0.681148392757953
           0.834943208419999
           0.895872813222938
           0.437597918328548
           0.399655288850365
           0.440119954134542
           0.309626357593902
           0.446953372036611
           0.964390123247796
           0.462348232342065
           0.495992012385964
           0.021539892790207
           0.192285131466523
           0.898134260529596
           0.389292223420651
           0.102046154076110
           0.349698581677999
           0.178546091108624
           0.249091062376147
           0.640984449884642
           0.975754160166402
           0.920663851687385
           0.053806928500179
           0.903084679011044
           0.189999378694629
           0.992615197724179
           0.326499595591164
           0.227543495774090
           0.943710729255865
           0.810846874136766
           0.924444160009448
           0.718502000394367
           0.879256561257223
           0.865061767470056
           0.357425088447911
           0.136276468350636];

%% 8. Compute the stiffness matrices for each patch with and without the pagewise computation

% Patch 1 :
% _________

constMtx1 = 'undefined';
tanMtxLoad1 = 'undefined';
BSplinePatches{1}.CPd = computeDisplacedControlPointsForIGAKirchhoffLoveShell...
    (BSplinePatches{1}.CP,dHat1);
dHatSaved1 = 'undefined';
dHatDot1 = 'undefined';
dHatDotSaved1 = 'undefined';
noWeakDBCCnd1 = 'undefined';
noPatch1 = 2;

% Pagewise computation
KPagewise1 = computeTangentStiffMtxResVctIGAMembraneNLinear...
    (constMtx1,tanMtxLoad1,dHat1,dHatSaved1,dHatDot1,dHatDotSaved1,patch1,...
    connections,propCoupling,loadFactor,noPatch1,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd1,propTransientAnalysis,tab,'');
KPagewise1 = full(KPagewise1);

% Serial computation
KSerial1 = computeTangentStiffMtxResVctIGAMembraneNLinearOutdated...
    (constMtx1,tanMtxLoad1,dHat1,dHatSaved1,dHatDot1,dHatDotSaved1,patch1,...
    connections,propCoupling,loadFactor,noPatch1,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd1,propTransientAnalysis,tab,'');

% Patch 2 :
% _________

constMtx2 = 'undefined';
tanMtxLoad2 = 'undefined';
BSplinePatches{2}.CPd = computeDisplacedControlPointsForIGAKirchhoffLoveShell...
    (BSplinePatches{2}.CP,dHat2);
dHatSaved2 = 'undefined';
dHatDot2 = 'undefined';
dHatDotSaved2 = 'undefined';
noWeakDBCCnd2 = 'undefined';
noPatch2 = 2;

% Pagewise computation
KPagewise2 = computeTangentStiffMtxResVctIGAMembraneNLinear...
    (constMtx2,tanMtxLoad2,dHat2,dHatSaved2,dHatDot2,dHatDotSaved2,patch2,...
    connections,propCoupling,loadFactor,noPatch2,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd2,propTransientAnalysis,tab,'');
KPagewise2 = full(KPagewise2);

% Serial computation
KSerial2 = computeTangentStiffMtxResVctIGAMembraneNLinearOutdated...
    (constMtx2,tanMtxLoad2,dHat2,dHatSaved2,dHatDot2,dHatDotSaved2,patch2,...
    connections,propCoupling,loadFactor,noPatch2,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd2,propTransientAnalysis,tab,'');

% Patch 3 :
% _________

constMtx3 = 'undefined';
tanMtxLoad3 = 'undefined';
BSplinePatches{3}.CPd = computeDisplacedControlPointsForIGAKirchhoffLoveShell...
    (BSplinePatches{3}.CP,dHat3);
dHatSaved3 = 'undefined';
dHatDot3 = 'undefined';
dHatDotSaved3 = 'undefined';
noWeakDBCCnd3 = 'undefined';
noPatch3 = 3;

% Pagewise computation
KPagewise3 = computeTangentStiffMtxResVctIGAMembraneNLinear...
    (constMtx3,tanMtxLoad3,dHat3,dHatSaved3,dHatDot3,dHatDotSaved3,patch3,...
    connections,propCoupling,loadFactor,noPatch3,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd3,propTransientAnalysis,tab,'');
KPagewise3 = full(KPagewise3);

% Serial computation
KSerial3 = computeTangentStiffMtxResVctIGAMembraneNLinearOutdated...
    (constMtx3,tanMtxLoad3,dHat3,dHatSaved3,dHatDot3,dHatDotSaved3,patch3,...
    connections,propCoupling,loadFactor,noPatch3,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd3,propTransientAnalysis,tab,'');

% Patch 4 :
% _________

constMtx4 = 'undefined';
tanMtxLoad4 = 'undefined';
BSplinePatches{4}.CPd = computeDisplacedControlPointsForIGAKirchhoffLoveShell...
    (BSplinePatches{4}.CP,dHat4);
dHatSaved4 = 'undefined';
dHatDot4 = 'undefined';
dHatDotSaved4 = 'undefined';
noWeakDBCCnd4 = 'undefined';
noPatch4 = 4;

% Pagewise computation
KPagewise4 = computeTangentStiffMtxResVctIGAMembraneNLinear...
    (constMtx4,tanMtxLoad4,dHat4,dHatSaved4,dHatDot4,dHatDotSaved4,patch4,...
    connections,propCoupling,loadFactor,noPatch4,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd4,propTransientAnalysis,tab,'');
KPagewise4 = full(KPagewise4);

% Serial computation
KSerial4 = computeTangentStiffMtxResVctIGAMembraneNLinearOutdated...
    (constMtx4,tanMtxLoad4,dHat4,dHatSaved4,dHatDot4,dHatDotSaved4,patch4,...
    connections,propCoupling,loadFactor,noPatch4,noTimeStep,...
    noNonlinearIteration,noWeakDBCCnd4,propTransientAnalysis,tab,'');

%% 9. Verify the components of the matrices using both computational methods

% Patch 1 :
% _________

testCase.verifyEqual(KPagewise1,KSerial1,'AbsTol',tol);

% Patch 2 :
% _________

testCase.verifyEqual(KPagewise2,KSerial2,'AbsTol',tol);

% Patch 3 :
% _________

testCase.verifyEqual(KPagewise3,KSerial3,'AbsTol',tol);

% Patch 4 :
% _________

testCase.verifyEqual(KPagewise4,KSerial4,'AbsTol',tolRelaxed);

end
